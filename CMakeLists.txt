SET(PROJECT_NAME git-chat)
PROJECT(${PROJECT_NAME} C)

CMAKE_MINIMUM_REQUIRED(VERSION 3.7.2)
SET(CMAKE_C_STANDARD 99)

IF(CMAKE_INSTALL_PREFIX_INITIALIZED_TO_DEFAULT)
	SET(CMAKE_INSTALL_PREFIX $ENV{HOME}/ CACHE PATH "Install prefix default" FORCE)
ENDIF(CMAKE_INSTALL_PREFIX_INITIALIZED_TO_DEFAULT)

# compiler options
IF(CMAKE_COMPILER_IS_GNUCC)
	ADD_DEFINITIONS(-Wall -Werror -pedantic -std=c99)
ENDIF(CMAKE_COMPILER_IS_GNUCC)

#
# Configure Project
#
EXECUTE_PROCESS(
		COMMAND git rev-parse --short HEAD
		WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}
		OUTPUT_VARIABLE GIT_COMMIT_SHORT_HASH
		OUTPUT_STRIP_TRAILING_WHITESPACE
)
SET(CMAKE_PROJECT_VERSION_MAJOR "0")
SET(CMAKE_PROJECT_VERSION_MINOR "1.git-${GIT_COMMIT_SHORT_HASH}")

CONFIGURE_FILE(
	"${PROJECT_SOURCE_DIR}/templates/version.h.in"
	"${PROJECT_BINARY_DIR}/include/version.h"
)

FILE(GLOB_RECURSE SRC_LIST FOLLOW_SYMLINKS src/*.c)
FILE(GLOB_RECURSE HEAD_FILES FOLLOW_SYMLINKS include/*.h ${PROJECT_BINARY_DIR}/include/*.h)
FILE(GLOB_RECURSE SHARE_LIST FOLLOW_SYMLINKS share/*)

#
# Set Include Directories
#
INCLUDE_DIRECTORIES(
	"${PROJECT_SOURCE_DIR}/include/"
	"${PROJECT_BINARY_DIR}/include/"
)

#
# Configure git-chat Executable and Installation
#
ADD_EXECUTABLE(${PROJECT_NAME} ${PROJECT_SOURCE_DIR}/src/git-chat.c ${SRC_LIST})
INSTALL(TARGETS ${PROJECT_NAME} RUNTIME DESTINATION bin)
INSTALL(DIRECTORY ${PROJECT_SOURCE_DIR}/share/ DESTINATION share/${PROJECT_NAME})
CONFIGURE_FILE(
		"${PROJECT_SOURCE_DIR}/ci/run-build.sh"
		"${PROJECT_BINARY_DIR}/run-build.sh"
		COPYONLY
)

#
# Configure Man Page Installation
#
ADD_SUBDIRECTORY(${PROJECT_SOURCE_DIR}/docs)

#
# Configure Unit and Integration Tests
#
ENABLE_TESTING()
ADD_SUBDIRECTORY(${PROJECT_SOURCE_DIR}/test)